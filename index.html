<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 24px;
            font-weight: 300;
        }
        
        .current-track {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
        }
        
        .track-title {
            font-size: 18px;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }
        
        .track-artist {
            font-size: 14px;
            color: #666;
        }
        
        .controls {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            -ms-flex-pack: center;
            justify-content: center;
            -webkit-box-align: center;
            -webkit-align-items: center;
            -ms-flex-align: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-btn {
            background: #667eea;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            -webkit-transition: all 0.3s ease;
            transition: all 0.3s ease;
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            -ms-flex-pack: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: #5a67d8;
            -webkit-transform: scale(1.05);
            transform: scale(1.05);
        }
        
        .play-btn {
            width: 60px;
            height: 60px;
            font-size: 24px;
        }
        
        .progress-container {
            margin-bottom: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            -webkit-transition: width 0.1s ease;
            transition: width 0.1s ease;
        }
        
        .time-info {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            -ms-flex-pack: justify;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .playlist {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.05);
        }
        
        .track-item {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
            -webkit-transition: background 0.2s ease;
            transition: background 0.2s ease;
        }
        
        .track-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .track-item.active {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .track-item:last-child {
            border-bottom: none;
        }
        
        .track-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 3px;
        }
        
        .track-meta {
            font-size: 12px;
            color: #666;
        }
        
        .volume-container {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            -ms-flex-align: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .volume-slider {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            -ms-flex: 1;
            flex: 1;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .volume-icon {
            color: #667eea;
            font-size: 16px;
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ Music Player</h1>
        </div>
        
        <div class="current-track">
            <div class="track-title" id="currentTitle">Select a track</div>
            <div class="track-artist" id="currentArtist">No track playing</div>
        </div>
        
        <div class="controls">
            <button class="control-btn" id="prevBtn">‚èÆ</button>
            <button class="control-btn play-btn" id="playBtn">‚ñ∂</button>
            <button class="control-btn" id="nextBtn">‚è≠</button>
        </div>
        
        <div class="volume-container">
            <span class="volume-icon">üîä</span>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="time-info">
                <span id="currentTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>
        </div>
        
        <div class="playlist" id="playlist">
            <!-- tracks will be loaded here dynamically -->
        </div>
        
        <audio id="audioPlayer" preload="metadata"></audio>
    </div>
    <script src="config.js"></script>
    <script>
        // navidrome server configuration
        var NAVIDROME_URL = CONFIG.NAVIDROME_URL;
        var USERNAME = CONFIG.USERNAME;
        var PASSWORD = CONFIG.PASSWORD;
        var CLIENT_NAME = CONFIG.CLIENT_NAME;
        var API_VERSION = '1.16.1';
        
        var playlist = [];
        var isLoading = true;
        
        var currentTrackIndex = -1;
        var isPlaying = false;
        var audioPlayer = document.getElementById('audioPlayer');
        var playBtn = document.getElementById('playBtn');
        var prevBtn = document.getElementById('prevBtn');
        var nextBtn = document.getElementById('nextBtn');
        var progressBar = document.getElementById('progressBar');
        var progressFill = document.getElementById('progressFill');
        var currentTime = document.getElementById('currentTime');
        var totalTime = document.getElementById('totalTime');
        var currentTitle = document.getElementById('currentTitle');
        var currentArtist = document.getElementById('currentArtist');
        var volumeSlider = document.getElementById('volumeSlider');
        var playlistEl = document.getElementById('playlist');
        
        // Check if CONFIG exists
        if (typeof CONFIG === 'undefined') {
            alert("Error: Configuration not loaded. Please create config.js!");
            throw new Error("Missing config.js");
        }
        // Initialize
        function init() {
            console.log("Initializing music player...");
            showLoading();
            setupEventListeners();
            audioPlayer.volume = volumeSlider.value / 100;
            loadMusicLibrary();
        }

        
        function showLoading() {
            playlistEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading music library...</div>';
        }
        
        function showError(message) {
            playlistEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #d32f2f;">Error: ' + message + '</div>';
        }
        
        // Generate Subsonic API authentication token
        function generateToken() {
    var salt = Math.random().toString(36).substring(2, 15);
    var token = md5(PASSWORD + salt);
    console.log("Generated token:", { 
        password: PASSWORD, 
        salt: salt, 
        token: token 
    });
    return {
        u: USERNAME,
        t: token,
        s: salt,
        v: API_VERSION,
        c: CLIENT_NAME,
        f: 'json'
    };
}

// Update the API request builder
function buildApiUrl(endpoint, params = {}) {
    var auth = generateToken();
    var url = `${NAVIDROME_URL}/rest/${endpoint}?` +
              `u=${encodeURIComponent(auth.u)}` +
              `&t=${auth.t}` +
              `&s=${auth.s}` +
              `&v=${auth.v}` +
              `&c=${auth.c}` +
              `&f=${auth.f}`

for (var key in params) {
        url += `&${key}=${encodeURIComponent(params[key])}`;
    }
    
    console.log("Built API URL:", url);
    return url;
}
        
        // simple MD5 implementation for Subsonic auth
        function md5(str) {
    // Simple MD5 implementation compatible with Subsonic API requirements
    function safeAdd(x, y) {
        var lsw = (x & 0xFFFF) + (y & 0xFFFF);
        var msw = (x >> 16) + (y >> 16) + (lsw >> 16);
        return (msw << 16) | (lsw & 0xFFFF);
    }
    
    function bitRotateLeft(num, cnt) {
        return (num << cnt) | (num >>> (32 - cnt));
    }
    
    function md5cmn(q, a, b, x, s, t) {
        return safeAdd(bitRotateLeft(safeAdd(safeAdd(a, q), safeAdd(x, t)), s), b);
    }
    
    function md5ff(a, b, c, d, x, s, t) {
        return md5cmn((b & c) | ((~b) & d), a, b, x, s, t);
    }
    
    function md5gg(a, b, c, d, x, s, t) {
        return md5cmn((b & d) | (c & (~d)), a, b, x, s, t);
    }
    
    function md5hh(a, b, c, d, x, s, t) {
        return md5cmn(b ^ c ^ d, a, b, x, s, t);
    }
    
    function md5ii(a, b, c, d, x, s, t) {
        return md5cmn(c ^ (b | (~d)), a, b, x, s, t);
    }
    
    function str2binl(str) {
        var bin = Array();
        var mask = (1 << 8) - 1;
        for(var i = 0; i < str.length * 8; i += 8) {
            bin[i>>5] |= (str.charCodeAt(i / 8) & mask) << (i%32);
        }
        return bin;
    }
    
    function binl2hex(binarray) {
        var hex_tab = '0123456789abcdef';
        var str = '';
        for(var i = 0; i < binarray.length * 4; i++) {
            str += hex_tab.charAt((binarray[i>>2] >> ((i%4)*8+4)) & 0xF) +
                   hex_tab.charAt((binarray[i>>2] >> ((i%4)*8)) & 0xF);
        }
        return str;
    }
    
    // Add padding to the string
    str = unescape(encodeURIComponent(str)); // Handle UTF-8
    var nblk = ((str.length + 8) >> 6) + 1;
    var blks = new Array(nblk * 16);
    for(var i = 0; i < nblk * 16; i++) blks[i] = 0;
    for(i = 0; i < str.length; i++) {
        blks[i>>2] |= str.charCodeAt(i) << ((i%4) * 8);
    }
    blks[i>>2] |= 0x80 << ((i%4) * 8);
    blks[nblk*16-2] = str.length * 8;
    
    // Initialize variables
    var a =  1732584193;
    var b = -271733879;
    var c = -1732584194;
    var d =  271733878;
    
    // Process each 16-word block
    for(i = 0; i < blks.length; i += 16) {
        var olda = a;
        var oldb = b;
        var oldc = c;
        var oldd = d;
        
        // Round 1
        a = md5ff(a, b, c, d, blks[i+0],  7, -680876936);
        d = md5ff(d, a, b, c, blks[i+1], 12, -389564586);
        c = md5ff(c, d, a, b, blks[i+2], 17,  606105819);
        b = md5ff(b, c, d, a, blks[i+3], 22, -1044525330);
        a = md5ff(a, b, c, d, blks[i+4],  7, -176418897);
        d = md5ff(d, a, b, c, blks[i+5], 12,  1200080426);
        c = md5ff(c, d, a, b, blks[i+6], 17, -1473231341);
        b = md5ff(b, c, d, a, blks[i+7], 22, -45705983);
        a = md5ff(a, b, c, d, blks[i+8],  7,  1770035416);
        d = md5ff(d, a, b, c, blks[i+9], 12, -1958414417);
        c = md5ff(c, d, a, b, blks[i+10],17, -42063);
        b = md5ff(b, c, d, a, blks[i+11],22, -1990404162);
        a = md5ff(a, b, c, d, blks[i+12], 7,  1804603682);
        d = md5ff(d, a, b, c, blks[i+13],12, -40341101);
        c = md5ff(c, d, a, b, blks[i+14],17, -1502002290);
        b = md5ff(b, c, d, a, blks[i+15],22,  1236535329);
        
        // Round 2
        a = md5gg(a, b, c, d, blks[i+1], 5, -165796510);
        d = md5gg(d, a, b, c, blks[i+6], 9, -1069501632);
        c = md5gg(c, d, a, b, blks[i+11],14,  643717713);
        b = md5gg(b, c, d, a, blks[i+0], 20, -373897302);
        a = md5gg(a, b, c, d, blks[i+5], 5, -701558691);
        d = md5gg(d, a, b, c, blks[i+10], 9,  38016083);
        c = md5gg(c, d, a, b, blks[i+15],14, -660478335);
        b = md5gg(b, c, d, a, blks[i+4], 20, -405537848);
        a = md5gg(a, b, c, d, blks[i+9], 5,  568446438);
        d = md5gg(d, a, b, c, blks[i+14], 9, -1019803690);
        c = md5gg(c, d, a, b, blks[i+3],14, -187363961);
        b = md5gg(b, c, d, a, blks[i+8], 20,  1163531501);
        a = md5gg(a, b, c, d, blks[i+13], 5, -1444681467);
        d = md5gg(d, a, b, c, blks[i+2], 9, -51403784);
        c = md5gg(c, d, a, b, blks[i+7],14,  1735328473);
        b = md5gg(b, c, d, a, blks[i+12],20, -1926607734);
        
        // Round 3
        a = md5hh(a, b, c, d, blks[i+5], 4, -378558);
        d = md5hh(d, a, b, c, blks[i+8], 11, -2022574463);
        c = md5hh(c, d, a, b, blks[i+11],16,  1839030562);
        b = md5hh(b, c, d, a, blks[i+14],23, -35309556);
        a = md5hh(a, b, c, d, blks[i+1], 4, -1530992060);
        d = md5hh(d, a, b, c, blks[i+4], 11,  1272893353);
        c = md5hh(c, d, a, b, blks[i+7],16, -155497632);
        b = md5hh(b, c, d, a, blks[i+10],23, -1094730640);
        a = md5hh(a, b, c, d, blks[i+13], 4,  681279174);
        d = md5hh(d, a, b, c, blks[i+0], 11, -358537222);
        c = md5hh(c, d, a, b, blks[i+3],16, -722521979);
        b = md5hh(b, c, d, a, blks[i+6],23,  76029189);
        a = md5hh(a, b, c, d, blks[i+9], 4, -640364487);
        d = md5hh(d, a, b, c, blks[i+12],11, -421815835);
        c = md5hh(c, d, a, b, blks[i+15],16,  530742520);
        b = md5hh(b, c, d, a, blks[i+2],23, -995338651);
        
        // Round 4
        a = md5ii(a, b, c, d, blks[i+0], 6, -198630844);
        d = md5ii(d, a, b, c, blks[i+7], 10,  1126891415);
        c = md5ii(c, d, a, b, blks[i+14],15, -1416354905);
        b = md5ii(b, c, d, a, blks[i+5], 21, -57434055);
        a = md5ii(a, b, c, d, blks[i+12], 6,  1700485571);
        d = md5ii(d, a, b, c, blks[i+3], 10, -1894986606);
        c = md5ii(c, d, a, b, blks[i+10],15, -1051523);
        b = md5ii(b, c, d, a, blks[i+1], 21, -2054922799);
        a = md5ii(a, b, c, d, blks[i+8], 6,  1873313359);
        d = md5ii(d, a, b, c, blks[i+15],10, -30611744);
        c = md5ii(c, d, a, b, blks[i+6],15, -1560198380);
        b = md5ii(b, c, d, a, blks[i+13],21,  1309151649);
        a = md5ii(a, b, c, d, blks[i+4], 6, -145523070);
        d = md5ii(d, a, b, c, blks[i+11],10, -1120210379);
        c = md5ii(c, d, a, b, blks[i+2],15,  718787259);
        b = md5ii(b, c, d, a, blks[i+9],21, -343485551);
        
        a = safeAdd(a, olda);
        b = safeAdd(b, oldb);
        c = safeAdd(c, oldc);
        d = safeAdd(d, oldd);
    }
    return binl2hex([a, b, c, d]);
}
        
        function loadMusicLibrary() {
    console.log("Attempting to load music library...");
    var url = buildApiUrl('getAlbumList2.view', {
        type: 'recent',
        size: 20
    });

    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            console.log("Response received:", xhr.status, xhr.responseText);
            if (xhr.status === 200) {
                try {
                    var response = JSON.parse(xhr.responseText);
                    if (response['subsonic-response']) {
                        if (response['subsonic-response'].status === 'ok') {
                            // Process successful response
                            if (response['subsonic-response'].albumList2) {
                                var albums = response['subsonic-response'].albumList2.album || [];
                                if (albums.length > 0) {
                                    loadAlbumSongs(albums[0].id);
                                } else {
                                    showError('No albums found');
                                }
                            }
                        } else {
                            var error = response['subsonic-response'].error || {};
                            console.error("API Error:", error);
                            showError(error.message || 'API request failed');
                            
                            // Special handling for auth errors
                            if (error.code === 40) {
                                showError('Wrong username or password. Please check credentials.');
                            }
                        }
                    }
                } catch (e) {
                    console.error("Parse error:", e);
                    showError('Failed to parse server response');
                }
            } else {
                showError('Network error: ' + xhr.status);
            }
        }
    };
    
    xhr.onerror = function() {
        showError('Network request failed');
    };
    
    xhr.send();
}


function attemptSearchFallback() {
    console.log("Attempting search fallback...");
    var auth = btoa(USERNAME + ':' + PASSWORD);
    var url = NAVIDROME_URL + '/rest/search3.view?query=*&songCount=50&f=json&v=1.15.0&c=' + CLIENT_NAME;
    
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.setRequestHeader('Authorization', 'Basic ' + auth);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try {
                    var response = JSON.parse(xhr.responseText);
                    if (response['subsonic-response'] && response['subsonic-response'].searchResult3) {
                        var songs = response['subsonic-response'].searchResult3.song || [];
                        console.log("Found songs via search:", songs.length);
                        if (songs.length > 0) {
                            parsePlaylist(songs);
                        } else {
                            showError('No songs found in library');
                        }
                    } else {
                        showError('Unexpected API response format');
                    }
                } catch (e) {
                    showError('Failed to parse search results');
                }
            } else {
                showError('Failed to load music (Status: ' + xhr.status + ')');
            }
        }
    };
    
    xhr.send();
}
        
        function loadAlbumSongs(albumId) {
    console.log("Loading songs for album:", albumId);
    var url = buildApiUrl('getAlbum.view', {
        id: albumId
    });

    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try {
                    var response = JSON.parse(xhr.responseText);
                    console.log("Album response:", response);
                    
                    if (response['subsonic-response'] && response['subsonic-response'].status === 'ok') {
                        if (response['subsonic-response'].album) {
                            var album = response['subsonic-response'].album;
                            
                            // Navidrome returns songs directly in the album object
                            var songs = album.song || [];
                            console.log("Found songs in album:", songs.length);
                            
                            if (songs.length > 0) {
                                parsePlaylist(songs);
                            } else {
                                // Fallback to search if no songs found
                                showError('No songs found in album, trying search...');
                                attemptSearchFallback();
                            }
                        } else {
                            showError('Album data not found in response');
                        }
                    } else {
                        showError(response['subsonic-response'].error.message);
                    }
                } catch (e) {
                    console.error("Error:", e);
                    showError('Failed to parse album songs');
                }
            } else {
                showError('Failed to load album songs: ' + xhr.status);
            }
        }
    };
    
    xhr.send();
}
        
        function parsePlaylist(songs) {
    console.log("Parsing playlist from", songs.length, "songs");
    playlist = [];
    
    for (var i = 0; i < songs.length; i++) {
        var song = songs[i];
        var authParams = generateToken();
        
        var streamUrl = buildApiUrl('stream.view', {
            id: song.id
        });

        playlist.push({
            title: song.title || 'Unknown Title',
            artist: song.artist || 'Unknown Artist',
            url: streamUrl,
            duration: song.duration || 0,
            id: song.id,
            album: song.album || 'Unknown Album'
        });
    }
    
    isLoading = false;
    renderPlaylist();
    
    // Auto-play first track if we have songs
    if (playlist.length > 0) {
        loadTrack(0);
    } else {
        showError('No playable tracks found');
    }
}
        
        function renderPlaylist() {
    if (isLoading) {
        showLoading();
        return;
    }
    
    if (playlist.length === 0) {
        showError('No songs found');
        return;
    }
    
    var html = '';
    for (var i = 0; i < playlist.length; i++) {
        var track = playlist[i];
        html += '<div class="track-item" data-index="' + i + '">';
        html += '<div class="track-name">' + escapeHtml(track.title) + '</div>';
        html += '<div class="track-meta">' + escapeHtml(track.artist) + ' ‚Ä¢ ' + escapeHtml(track.album) + '</div>';
        html += '</div>';
    }
    playlistEl.innerHTML = html;
}
        
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function setupEventListeners() {
            playBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', previousTrack);
            nextBtn.addEventListener('click', nextTrack);
            
            volumeSlider.addEventListener('input', function() {
                audioPlayer.volume = this.value / 100;
            });
            
            progressBar.addEventListener('click', function(e) {
                var rect = this.getBoundingClientRect();
                var pos = (e.clientX - rect.left) / rect.width;
                audioPlayer.currentTime = pos * audioPlayer.duration;
            });
            
            // Playlist item clicks
            playlistEl.addEventListener('click', function(e) {
                var trackItem = e.target;
                while (trackItem && !trackItem.classList.contains('track-item')) {
                    trackItem = trackItem.parentNode;
                }
                if (trackItem) {
                    var index = parseInt(trackItem.getAttribute('data-index'));
                    loadTrack(index);
                    play();
                }
            });
            
            // Audio events
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', nextTrack);
            audioPlayer.addEventListener('play', function() {
                isPlaying = true;
                playBtn.innerHTML = '‚è∏';
            });
            audioPlayer.addEventListener('pause', function() {
                isPlaying = false;
                playBtn.innerHTML = '‚ñ∂';
            });
        }
        
        function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            
            // Remove active class from all items
            var items = document.querySelectorAll('.track-item');
            for (var i = 0; i < items.length; i++) {
                items[i].classList.remove('active');
            }
            
            // Add active class to current item
            if (items[index]) {
                items[index].classList.add('active');
            }
            
            currentTrackIndex = index;
            var track = playlist[index];
            
            // Set up authenticated audio source
            audioPlayer.src = track.url;
            audioPlayer.setAttribute('type', 'audio/mpeg');
            
            // For iOS, we need to load the audio differently
            if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
                // iOS requires direct setting of src with credentials
                audioPlayer.src = track.url + '&_t=' + new Date().getTime();
            }
            
            currentTitle.textContent = track.title;
            currentArtist.textContent = track.artist;
        }
        
        function togglePlay() {
            if (currentTrackIndex === -1 && playlist.length > 0) {
                loadTrack(0);
            }
            
            if (isPlaying) {
                pause();
            } else {
                play();
            }
        }
        
        function play() {
            // iOS requires this to be triggered by user gesture
            var promise = audioPlayer.play();
            
            if (promise !== undefined) {
                promise.catch(function(error) {
                    // Auto-play was prevented, show play button
                    isPlaying = false;
                    playBtn.innerHTML = '‚ñ∂';
                });
            }
        }
        
        function pause() {
            audioPlayer.pause();
        }
        
        function previousTrack() {
            var newIndex = currentTrackIndex - 1;
            if (newIndex < 0) newIndex = playlist.length - 1;
            loadTrack(newIndex);
            if (isPlaying) play();
        }
        
        function nextTrack() {
            var newIndex = currentTrackIndex + 1;
            if (newIndex >= playlist.length) newIndex = 0;
            loadTrack(newIndex);
            if (isPlaying) play();
        }
        
        function updateDuration() {
            totalTime.textContent = formatTime(audioPlayer.duration);
        }
        
        function updateProgress() {
            var progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressFill.style.width = progress + '%';
            currentTime.textContent = formatTime(audioPlayer.currentTime);
        }
        
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            init();
        });
    </script>
</body>
</html>